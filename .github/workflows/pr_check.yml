name: Check the integrity of the PR

on:
  pull_request:
    types: [opened, reopened, synchronize, edited]

  workflow_dispatch:
    inputs:
      chapters:
        description: 'Chapter numbers to check (separated with comma, semicolon or space - e.g., "1,2,5,26"). Leave empty for auto-detect or "all" for full check.'
        required: false
        default: ''
        type: string

permissions:
  contents: read

env:
  # allowed top-level files/folders beside chapter folders like "01_..." and the 00_ book folder
  ALLOWED_TOP_LEVEL_STATIC: ".github,.gitignore,README.md,LICENSE,00_L3T"
  # required metadata keys (in HTML comments at top of each md file)
  METADATA_KEYS: "filename,title,slug,tags,authors,revisors"

jobs:
  pr-structure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch for comparison
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
          else
            # For workflow_dispatch, fetch default branch
            git fetch origin ${{ github.event.repository.default_branch || 'main' }}
          fi

      - name: Detect changed chapters
        id: changed-chapters
        run: |
          # Manual input takes precedence
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.chapters }}" ]; then
            if [ "${{ inputs.chapters }}" = "all" ]; then
              echo "chapters=" >> $GITHUB_OUTPUT
              echo "Running full check (manual: all)"
            else
              echo "chapters=${{ inputs.chapters }}" >> $GITHUB_OUTPUT
              echo "Running check for specified chapters: ${{ inputs.chapters }}"
            fi
          else
            # Auto-detect changed files
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              BASE_REF="origin/${{ github.base_ref }}"
            else
              BASE_REF="origin/${{ github.event.repository.default_branch || 'main' }}"
            fi
            
            echo "Comparing against: $BASE_REF"
            CHANGED_FILES=$(git diff --name-only $BASE_REF...HEAD || echo "")
            echo "Changed files:"
            echo "$CHANGED_FILES"
            
            # Check if critical files changed (00_L3T, README.md, ...) → full check
            if echo "$CHANGED_FILES" | grep -qE '^(00_L3T/|README\.md|\.github/)'; then
              echo "chapters=" >> $GITHUB_OUTPUT
              echo "Running full check (critical files changed)"
            else
              # Extract unique chapter numbers from folder names (e.g., "01_Einleitung" → "1")
              CHAPTERS=$(echo "$CHANGED_FILES" | grep -E '^[0-9]{2}_[^/]+/' | cut -d'/' -f1 | sed 's/^0*//' | cut -d'_' -f1 | sort -u | tr '\n' ',' | sed 's/,$//')
              
              if [ -z "$CHAPTERS" ]; then
                echo "chapters=" >> $GITHUB_OUTPUT
                echo "No chapter changes detected, running full check"
              else
                echo "chapters=$CHAPTERS" >> $GITHUB_OUTPUT
                echo "Changed chapters: $CHAPTERS"
              fi
            fi
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: python -m pip install --upgrade pip && python -m pip install -r .github/pr_check/requirements.txt

      - name: Run structural checks
        run: |
          if [ -n "${{ steps.changed-chapters.outputs.chapters }}" ]; then
            echo "Running checks for specific chapters: ${{ steps.changed-chapters.outputs.chapters }}"
            python .github/pr_check/check_pr.py --chapters "${{ steps.changed-chapters.outputs.chapters }}"
          else
            echo "Running full check (all chapters)"
            python .github/pr_check/check_pr.py
          fi